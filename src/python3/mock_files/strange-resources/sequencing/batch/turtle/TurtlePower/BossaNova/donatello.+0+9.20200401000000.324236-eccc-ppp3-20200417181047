#!/bin/ksh
#PBS -j oe
#PBS -o /fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle/sequencing/output/turtle/TurtlePower/BossaNova/donatello.+0+9.eccc-ppp3-324236-hpcr3-in-20200417181047.out.o
#PBS -l select=1:ncpus=1:mem=3000M:res_tmpfs=100:res_image=eccc/eccc_all_ppp_ubuntu-18.04-amd64_latest -l place=free -r n
#PBS -l place=scatter
##PBS -l nodes=1:ppn=1 -l mem=3000M
#PBS -N donatello.+0+9
#PBS -W umask=022
#PBS -S /bin/ksh
#PBS -l walltime=300
#PBS 
#PBS -q development
#PBS -m a
#PBS -M stuart.spence@canada.ca
#PBS 
#PBS 
#PBS 
#PBS 
#PBS 
#PBS 
#PBS 
#
#SOUMET_RESOURCE_PROFILE_FOR_JOB MaxNumberOfCores=1;MaxNumberOfThreads=1;MaxWallTime=300

export ORDSOUMET_date_runwrapper=$(LC_TIME=C date)
export ORDSOUMET_SMT_FACTOR="1"

export UniqueTag=20200417181047.628e9900
export AnSwErD=""

if [ -z "${ORDENV_SETUP}" -a -z "${SETUP_DONE}" ]; then
	. /etc/profile
	. ${HOME}/.profile
fi

echo "==================== ${PBS_JOBID} ====================" >>/fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle/sequencing/output/turtle/TurtlePower/BossaNova/donatello.+0+9.eccc-ppp3-324236-hpcr3-in-20200417181047.out
export ListingFile=/fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle/sequencing/output/turtle/TurtlePower/BossaNova/donatello.+0+9.eccc-ppp3-324236-hpcr3-in-20200417181047.out
chmod 644 ${ListingFile}
exec 1>>${ListingFile} 2>>${ListingFile}

echo UniqueTag=${UniqueTag}
#ln /home/sts271/.ord_soumet.d/wrap/jobinfo/.base_info /home/sts271/.ord_soumet.d/wrap/jobinfo/20200417181047.628e9900.${ListingFile##*/} || { echo ===== This job looks like a RERUN ===== ; exit 0 ; }
export JOB_ID="${PBS_JOBID}"
test -n "" && . s.ssmuse.dot 

export SelfJobResubmit="jobsub -c ppp3.science.gc.ca /fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle/sequencing/batch/turtle/TurtlePower/BossaNova/donatello.+0+9.20200401000000.324236-eccc-ppp3-20200417181047"
export SelfJobRemove="rm -f /fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle/sequencing/jobinfo//turtle/TurtlePower/BossaNova/20200401000000@${JOB_ID:-${LOADL_STEP_ID%.*}} >/dev/null 2>&1 || true "
#export SelfJobKill="jobdel -c ppp3.science.gc.ca ${JOB_ID:-${LOADL_STEP_ID}}"
export SelfJobKill="jobdel -c ppp3.science.gc.ca ${JOB_ID%%.*}"

#[[  -lt 40 ]] && export FULL_UNBIND=true
[[ 1 -lt 40 ]] && export FULL_UNBIND=true

# Setup for modules, if available, to make sure it works for ksh
if [ -r /etc/ksh.kshrc ]
then
. /etc/ksh.kshrc
fi
unset BASH_ENV

. ssmuse-sh -d /fs/ssm/eccc/cmo/isst/maestro/1.6.8 
export SEQ_MAESTRO_SHORTCUT=". ssmuse-sh -d /fs/ssm/eccc/cmo/isst/maestro/1.6.8" 
export SEQ_EXP_HOME=/fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle
export SEQ_EXP_NAME=turtle
export SEQ_TRACE_LEVEL=TL_CRITICAL
export SEQ_MODULE=turtle
export SEQ_CONTAINER=/turtle/TurtlePower/BossaNova
export SEQ_CURRENT_MODULE=turtle
export SEQ_CURRENT_CONTAINER=/turtle/TurtlePower/BossaNova
export SEQ_NPEX=1
export SEQ_NODE=/turtle/TurtlePower/BossaNova/donatello
export SEQ_NAME=donatello
export SEQ_LOOP_ARGS="-l TurtlePower=0,BossaNova=9"
export SEQ_LOOP_EXT="+0+9"
export SEQ_CONTAINER_LOOP_ARGS="-l TurtlePower=0,BossaNova=9"
export SEQ_CONTAINER_LOOP_EXT="+0+9"
export TurtlePower=0 
export BossaNova=9 
export SEQ_XFER=continue
export SEQ_WORKER_PATH=
export SEQ_TMP_CFG=/fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle/sequencing/tmpfile//turtle/TurtlePower/BossaNova/donatello.+0+9.20200401000000.323901.cfg
export SEQ_DATE=20200401000000
export SEQ_SHORT_DATE=2020040100

if [[ "${SEQ_LOOP_EXT}" == "" ]] ; then  
   jobout=/fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle/sequencing/output/turtle/TurtlePower/BossaNova/${SEQ_NAME}.20200401000000.pgmout${JOB_ID}.$$
else
   jobout=/fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle/sequencing/output/turtle/TurtlePower/BossaNova/${SEQ_NAME}.${SEQ_LOOP_EXT}.20200401000000.pgmout${JOB_ID}.$$
fi
set -ex
exec 2>$jobout >> $jobout 1>&2
function maestro_trap
{
  set -x
  printf "CODE ABORTS -- Check lines before trap statement for error.\n"
  ${SEQ_BIN}/maestro -s abort -f continue -n ${SEQ_NODE} ${SEQ_LOOP_ARGS}
  ${SEQ_BIN}/nodetracer -n ${SEQ_NODE} ${SEQ_LOOP_ARGS} -d ${SEQ_DATE} -type abort -i $jobout -c
  eval ${SelfJobRemove}
  rm -f ${SEQ_TMP_CFG}.complete ${SEQ_TMP_CFG}
  exit 1
}

trap 'trap "" ERR EXIT 12; maestro_trap ; exit 1' ERR EXIT 12
{
date 

 printf "Starting $SEQ_NODE $(date) JOB_ID=${JOB_ID:-${LOADL_STEP_ID}} 
 
 " 
 cd ${TMPDIR}
${SEQ_BIN}/maestro -s begin -n ${SEQ_NODE} -f ${SEQ_XFER} ${SEQ_LOOP_ARGS}
 SEQ_NODE_TYPE=$(${SEQ_BIN}/nodeinfo -n $SEQ_NODE -f type)
 if [[ ${SEQ_NODE_TYPE} = 'node.type=Task' ||  ${SEQ_NODE_TYPE} = 'node.type=NpassTask' ]] ; then 
 	 ${SEQ_BIN}/chaindot.py -e ${SEQ_EXP_HOME} -n ${SEQ_NODE} -o ${SEQ_TMP_CFG}.complete
 	 export SEQ_WORKBASE=$(nodework -n ${SEQ_NODE} ${SEQ_LOOP_ARGS} -base | cut -d ':' -f 2)
 if [[ -d ${SEQ_WORKBASE} ]]; then 
 	 touch ${SEQ_WORKBASE}
 else 
 	 mkdir -p $SEQ_WORKBASE
 fi
 	 . ${SEQ_BIN}/task_setup.dot -f ${SEQ_TMP_CFG}.complete --base $(nodework -n ${SEQ_NODE} ${SEQ_LOOP_ARGS} | cut -d ':' -f 2) --clean --verbose --force
 	 cd ${TASK_WORK} 
 fi
 printf "USER CODE BEGINS 
 " 
 printf " #____________________________________________________________#
 " 
. /fs/homeu1/eccc/cmod/cmoi/sts271/.suites/turtle/sequencing/wrapped/turtle/TurtlePower/BossaNova/donatello.+0+9.wrapped.20200401000000.324236-eccc-ppp3-20200417181047 
 printf " #____________________________________________________________#
 " 
 printf "USER CODE ENDS 
 " 
 set -x

${SEQ_BIN}/maestro -s end -n ${SEQ_NODE} -f ${SEQ_XFER} ${SEQ_LOOP_ARGS}
 printf " Ending $SEQ_NODE $(date) 
 " 
} 
echo ${SelfJobRemove} 
echo "nodetracer -n ${SEQ_NODE} ${SEQ_LOOP_ARGS} -d ${SEQ_DATE} -i ${jobout} -c" 
${SEQ_BIN}/nodetracer -n ${SEQ_NODE} ${SEQ_LOOP_ARGS} -d ${SEQ_DATE} -i ${jobout} -c 
eval ${SelfJobRemove}
rm -f ${SEQ_TMP_CFG}.complete ${SEQ_TMP_CFG} 
trap "" ERR EXIT 12
